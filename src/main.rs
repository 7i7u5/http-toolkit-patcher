// Prevent console window in addition to Slint window in Windows release builds when, e.g., starting the app via file manager. Ignored on other platforms.
#![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]

use rfd;
use std::{error::Error, fs};
use std::collections::HashMap;
use std::sync::{OnceLock};
use std::path::{ Path };
use native_dialog::{ DialogBuilder, MessageLevel };
use asar::{ AsarReader, AsarWriter };
use std::process::{Command};

slint::include_modules!();

struct Patch {
	original: Vec<u8>,
	replacement: Vec<u8>,
}

const PATCHER_VERSION: &str = "1.24.1";
static ASAR_PATHS: OnceLock<HashMap<String, Vec<String>>> = OnceLock::new();
static PATCHES: OnceLock<HashMap<String, Vec<Patch>>> = OnceLock::new();

fn init_asar_paths() -> &'static HashMap<String, Vec<String>> {
	ASAR_PATHS.get_or_init(|| {
		let mut m = HashMap::new();
		m.insert("windows".to_string(), vec![
			"C:\\Program Files\\httptoolkit\\resources\\app.asar".to_string(),
			format!("C:\\Users\\{}\\AppData\\Local\\Programs\\HTTP Toolkit\\resources\\app.asar", whoami::username())
		]);

		m.insert("linux".to_string(), vec![
			"/Applications/HTTP Toolkit.app/Contents/Resources/app.asar".to_string(),
			format!("/Users/{}/Applications/HTTP Toolkit.app/Contents/Resources/app.asar", whoami::username())
		]);

		m.insert("macos".to_string(), vec![
			"/usr/share/httptoolkit/resources/app.asar".to_string(),
			"/opt/httptoolkit/resources/app.asar".to_string(),
			format!("/home/{}/.local/share/httptoolkit/resources/app.asar", whoami::username()),
			format!("/home/{}/Applications/HTTP Toolkit.app/Contents/Resources/app.asar", whoami::username())
		]);

		return m;
	})
}

fn init_patches() -> &'static HashMap<String, Vec<Patch>> {
	PATCHES.get_or_init(|| {
		let mut m = HashMap::new();
		m.insert("build\\index.js".to_string(), vec![
			Patch {
				original: vec![
					0x20, 0x20, 0x20, 0x20, 0x7d, 0x29, 0x3b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x69, 0x66, 0x20, 0x28, 0x73, 0x68, 0x6f, 0x75, 0x6c, 0x64, 0x41, 0x75, 0x74, 0x6f, 0x48, 0x69, 0x64, 0x65, 0x4d, 0x65, 0x6e, 0x75, 0x28, 0x29, 0x29, 0x20, 0x7b				],
				replacement: vec![
					0x20, 0x20, 0x20, 0x20, 0x7d, 0x29, 0x3b, 0x0d, 0x0a, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x70, 0x61, 0x74, 0x63, 0x68, 0x5f, 0x61, 0x6c, 0x65, 0x72, 0x74, 0x3d, 0x28, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x2c, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x3d, 0x33, 0x65, 0x33, 0x29, 0x3d, 0x3e, 0x7b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x65, 0x78, 0x65, 0x63, 0x75, 0x74, 0x65, 0x4a, 0x61, 0x76, 0x61, 0x53, 0x63, 0x72, 0x69, 0x70, 0x74, 0x28, 0x60, 0x6c, 0x65, 0x74, 0x20, 0x64, 0x69, 0x76, 0x20, 0x3d, 0x20, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x45, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x28, 0x22, 0x64, 0x69, 0x76, 0x22, 0x29, 0x3b, 0x5c, 0x6e, 0x6c, 0x65, 0x74, 0x20, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x3d, 0x20, 0x24, 0x7b, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x7d, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x68, 0x65, 0x69, 0x67, 0x68, 0x74, 0x20, 0x3d, 0x20, 0x22, 0x34, 0x30, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x62, 0x61, 0x63, 0x6b, 0x67, 0x72, 0x6f, 0x75, 0x6e, 0x64, 0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x20, 0x3d, 0x20, 0x22, 0x72, 0x67, 0x62, 0x28, 0x35, 0x30, 0x2c, 0x20, 0x35, 0x32, 0x2c, 0x20, 0x35, 0x39, 0x29, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x70, 0x6f, 0x73, 0x69, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x3d, 0x20, 0x22, 0x66, 0x69, 0x78, 0x65, 0x64, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x62, 0x6f, 0x74, 0x74, 0x6f, 0x6d, 0x20, 0x3d, 0x20, 0x22, 0x2d, 0x35, 0x30, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x72, 0x69, 0x67, 0x68, 0x74, 0x20, 0x3d, 0x20, 0x22, 0x32, 0x30, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x6f, 0x70, 0x61, 0x63, 0x69, 0x74, 0x79, 0x20, 0x3d, 0x20, 0x30, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x62, 0x6f, 0x72, 0x64, 0x65, 0x72, 0x52, 0x61, 0x64, 0x69, 0x75, 0x73, 0x20, 0x3d, 0x20, 0x22, 0x35, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x64, 0x69, 0x73, 0x70, 0x6c, 0x61, 0x79, 0x20, 0x3d, 0x20, 0x22, 0x66, 0x6c, 0x65, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x61, 0x6c, 0x69, 0x67, 0x6e, 0x49, 0x74, 0x65, 0x6d, 0x73, 0x20, 0x3d, 0x20, 0x22, 0x63, 0x65, 0x6e, 0x74, 0x65, 0x72, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x6a, 0x75, 0x73, 0x74, 0x69, 0x66, 0x79, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x20, 0x3d, 0x20, 0x22, 0x63, 0x65, 0x6e, 0x74, 0x65, 0x72, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x63, 0x75, 0x72, 0x73, 0x6f, 0x72, 0x20, 0x3d, 0x20, 0x22, 0x70, 0x6f, 0x69, 0x6e, 0x74, 0x65, 0x72, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x70, 0x61, 0x64, 0x64, 0x69, 0x6e, 0x67, 0x20, 0x3d, 0x20, 0x22, 0x30, 0x20, 0x31, 0x35, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x62, 0x6f, 0x78, 0x53, 0x68, 0x61, 0x64, 0x6f, 0x77, 0x20, 0x3d, 0x20, 0x22, 0x32, 0x70, 0x78, 0x20, 0x33, 0x70, 0x78, 0x20, 0x36, 0x70, 0x78, 0x20, 0x72, 0x67, 0x62, 0x61, 0x28, 0x30, 0x2c, 0x20, 0x30, 0x2c, 0x20, 0x30, 0x2c, 0x20, 0x30, 0x2e, 0x35, 0x29, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x20, 0x3d, 0x20, 0x22, 0x72, 0x67, 0x62, 0x28, 0x32, 0x31, 0x38, 0x2c, 0x20, 0x32, 0x31, 0x39, 0x2c, 0x20, 0x32, 0x32, 0x33, 0x29, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x66, 0x6f, 0x6e, 0x74, 0x46, 0x61, 0x6d, 0x69, 0x6c, 0x79, 0x20, 0x3d, 0x20, 0x27, 0x22, 0x44, 0x4d, 0x20, 0x53, 0x61, 0x6e, 0x73, 0x22, 0x2c, 0x20, 0x41, 0x72, 0x69, 0x61, 0x6c, 0x2c, 0x20, 0x73, 0x61, 0x6e, 0x73, 0x2d, 0x73, 0x65, 0x72, 0x69, 0x66, 0x27, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x66, 0x6f, 0x6e, 0x74, 0x53, 0x69, 0x7a, 0x65, 0x20, 0x3d, 0x20, 0x22, 0x31, 0x37, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x74, 0x65, 0x78, 0x74, 0x44, 0x65, 0x63, 0x6f, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x3d, 0x20, 0x22, 0x6e, 0x6f, 0x6e, 0x65, 0x22, 0x3b, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x69, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x3d, 0x20, 0x22, 0x61, 0x6c, 0x6c, 0x20, 0x30, 0x2e, 0x35, 0x73, 0x20, 0x65, 0x61, 0x73, 0x65, 0x22, 0x3b, 0x5c, 0x6e, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x74, 0x65, 0x78, 0x74, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x20, 0x3d, 0x20, 0x22, 0x24, 0x7b, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x7d, 0x22, 0x3b, 0x5c, 0x6e, 0x5c, 0x6e, 0x64, 0x69, 0x76, 0x2e, 0x6f, 0x6e, 0x63, 0x6c, 0x69, 0x63, 0x6b, 0x20, 0x3d, 0x20, 0x28, 0x29, 0x20, 0x3d, 0x3e, 0x20, 0x7b, 0x5c, 0x6e, 0x20, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x6f, 0x70, 0x65, 0x6e, 0x28, 0x22, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x2f, 0x2f, 0x67, 0x69, 0x74, 0x68, 0x75, 0x62, 0x2e, 0x63, 0x6f, 0x6d, 0x2f, 0x37, 0x69, 0x37, 0x75, 0x35, 0x2f, 0x68, 0x74, 0x74, 0x70, 0x2d, 0x74, 0x6f, 0x6f, 0x6c, 0x6b, 0x69, 0x74, 0x2d, 0x70, 0x61, 0x74, 0x63, 0x68, 0x65, 0x72, 0x22, 0x2c, 0x20, 0x22, 0x5f, 0x62, 0x6c, 0x61, 0x6e, 0x6b, 0x22, 0x29, 0x3b, 0x5c, 0x6e, 0x7d, 0x3b, 0x5c, 0x6e, 0x5c, 0x6e, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x62, 0x6f, 0x64, 0x79, 0x2e, 0x61, 0x70, 0x70, 0x65, 0x6e, 0x64, 0x43, 0x68, 0x69, 0x6c, 0x64, 0x28, 0x64, 0x69, 0x76, 0x29, 0x3b, 0x5c, 0x6e, 0x5c, 0x6e, 0x73, 0x65, 0x74, 0x54, 0x69, 0x6d, 0x65, 0x6f, 0x75, 0x74, 0x28, 0x28, 0x29, 0x20, 0x3d, 0x3e, 0x20, 0x7b, 0x5c, 0x6e, 0x20, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x62, 0x6f, 0x74, 0x74, 0x6f, 0x6d, 0x20, 0x3d, 0x20, 0x22, 0x31, 0x30, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x20, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x6f, 0x70, 0x61, 0x63, 0x69, 0x74, 0x79, 0x20, 0x3d, 0x20, 0x30, 0x2e, 0x38, 0x3b, 0x5c, 0x6e, 0x7d, 0x2c, 0x20, 0x35, 0x30, 0x29, 0x3b, 0x5c, 0x6e, 0x5c, 0x6e, 0x73, 0x65, 0x74, 0x54, 0x69, 0x6d, 0x65, 0x6f, 0x75, 0x74, 0x28, 0x28, 0x29, 0x20, 0x3d, 0x3e, 0x20, 0x7b, 0x5c, 0x6e, 0x20, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x62, 0x6f, 0x74, 0x74, 0x6f, 0x6d, 0x20, 0x3d, 0x20, 0x22, 0x2d, 0x35, 0x30, 0x70, 0x78, 0x22, 0x3b, 0x5c, 0x6e, 0x20, 0x64, 0x69, 0x76, 0x2e, 0x73, 0x74, 0x79, 0x6c, 0x65, 0x2e, 0x6f, 0x70, 0x61, 0x63, 0x69, 0x74, 0x79, 0x20, 0x3d, 0x20, 0x30, 0x3b, 0x5c, 0x6e, 0x7d, 0x2c, 0x20, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x2b, 0x20, 0x35, 0x30, 0x30, 0x29, 0x3b, 0x5c, 0x6e, 0x5c, 0x6e, 0x73, 0x65, 0x74, 0x54, 0x69, 0x6d, 0x65, 0x6f, 0x75, 0x74, 0x28, 0x28, 0x29, 0x20, 0x3d, 0x3e, 0x20, 0x7b, 0x5c, 0x6e, 0x20, 0x64, 0x69, 0x76, 0x2e, 0x72, 0x65, 0x6d, 0x6f, 0x76, 0x65, 0x28, 0x29, 0x3b, 0x5c, 0x6e, 0x7d, 0x2c, 0x20, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x2b, 0x20, 0x31, 0x30, 0x30, 0x30, 0x29, 0x3b, 0x60, 0x29, 0x7d, 0x3b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x61, 0x74, 0x74, 0x61, 0x63, 0x68, 0x28, 0x22, 0x31, 0x2e, 0x33, 0x22, 0x29, 0x3b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x73, 0x65, 0x6e, 0x64, 0x43, 0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x28, 0x22, 0x4e, 0x65, 0x74, 0x77, 0x6f, 0x72, 0x6b, 0x2e, 0x65, 0x6e, 0x61, 0x62, 0x6c, 0x65, 0x22, 0x29, 0x3b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x73, 0x65, 0x6e, 0x64, 0x43, 0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x28, 0x22, 0x4e, 0x65, 0x74, 0x77, 0x6f, 0x72, 0x6b, 0x2e, 0x73, 0x65, 0x74, 0x42, 0x79, 0x70, 0x61, 0x73, 0x73, 0x53, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x57, 0x6f, 0x72, 0x6b, 0x65, 0x72, 0x22, 0x2c, 0x7b, 0x62, 0x79, 0x70, 0x61, 0x73, 0x73, 0x3a, 0x74, 0x72, 0x75, 0x65, 0x7d, 0x29, 0x3b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x73, 0x65, 0x6e, 0x64, 0x43, 0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x28, 0x22, 0x46, 0x65, 0x74, 0x63, 0x68, 0x2e, 0x65, 0x6e, 0x61, 0x62, 0x6c, 0x65, 0x22, 0x2c, 0x7b, 0x70, 0x61, 0x74, 0x74, 0x65, 0x72, 0x6e, 0x73, 0x3a, 0x5b, 0x7b, 0x75, 0x72, 0x6c, 0x50, 0x61, 0x74, 0x74, 0x65, 0x72, 0x6e, 0x3a, 0x22, 0x2a, 0x3a, 0x2f, 0x2f, 0x61, 0x70, 0x70, 0x2e, 0x68, 0x74, 0x74, 0x70, 0x74, 0x6f, 0x6f, 0x6c, 0x6b, 0x69, 0x74, 0x2e, 0x74, 0x65, 0x63, 0x68, 0x2f, 0x6d, 0x61, 0x69, 0x6e, 0x2e, 0x6a, 0x73, 0x2a, 0x22, 0x2c, 0x72, 0x65, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x54, 0x79, 0x70, 0x65, 0x3a, 0x22, 0x53, 0x63, 0x72, 0x69, 0x70, 0x74, 0x22, 0x2c, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x53, 0x74, 0x61, 0x67, 0x65, 0x3a, 0x22, 0x52, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x65, 0x22, 0x7d, 0x5d, 0x7d, 0x29, 0x3b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x6f, 0x6e, 0x28, 0x22, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x22, 0x2c, 0x28, 0x28, 0x65, 0x76, 0x65, 0x6e, 0x74, 0x2c, 0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x2c, 0x70, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x29, 0x3d, 0x3e, 0x7b, 0x69, 0x66, 0x28, 0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x21, 0x3d, 0x3d, 0x22, 0x46, 0x65, 0x74, 0x63, 0x68, 0x2e, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x50, 0x61, 0x75, 0x73, 0x65, 0x64, 0x22, 0x29, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x3b, 0x69, 0x66, 0x28, 0x21, 0x70, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x2e, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x65, 0x53, 0x74, 0x61, 0x74, 0x75, 0x73, 0x43, 0x6f, 0x64, 0x65, 0x29, 0x7b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x73, 0x65, 0x6e, 0x64, 0x43, 0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x28, 0x22, 0x46, 0x65, 0x74, 0x63, 0x68, 0x2e, 0x63, 0x6f, 0x6e, 0x74, 0x69, 0x6e, 0x75, 0x65, 0x52, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x22, 0x2c, 0x7b, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x3a, 0x70, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x2e, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x7d, 0x29, 0x3b, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x7d, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x3d, 0x70, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x2e, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x3b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x73, 0x65, 0x6e, 0x64, 0x43, 0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x28, 0x22, 0x46, 0x65, 0x74, 0x63, 0x68, 0x2e, 0x67, 0x65, 0x74, 0x52, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x65, 0x42, 0x6f, 0x64, 0x79, 0x22, 0x2c, 0x7b, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x3a, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x7d, 0x29, 0x2e, 0x74, 0x68, 0x65, 0x6e, 0x28, 0x28, 0x28, 0x7b, 0x62, 0x6f, 0x64, 0x79, 0x3a, 0x62, 0x6f, 0x64, 0x79, 0x2c, 0x62, 0x61, 0x73, 0x65, 0x36, 0x34, 0x45, 0x6e, 0x63, 0x6f, 0x64, 0x65, 0x64, 0x3a, 0x62, 0x61, 0x73, 0x65, 0x36, 0x34, 0x45, 0x6e, 0x63, 0x6f, 0x64, 0x65, 0x64, 0x7d, 0x29, 0x3d, 0x3e, 0x7b, 0x6c, 0x65, 0x74, 0x20, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x3d, 0x62, 0x61, 0x73, 0x65, 0x36, 0x34, 0x45, 0x6e, 0x63, 0x6f, 0x64, 0x65, 0x64, 0x3f, 0x42, 0x75, 0x66, 0x66, 0x65, 0x72, 0x2e, 0x66, 0x72, 0x6f, 0x6d, 0x28, 0x62, 0x6f, 0x64, 0x79, 0x2c, 0x22, 0x62, 0x61, 0x73, 0x65, 0x36, 0x34, 0x22, 0x29, 0x2e, 0x74, 0x6f, 0x53, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x28, 0x22, 0x75, 0x74, 0x66, 0x38, 0x22, 0x29, 0x3a, 0x62, 0x6f, 0x64, 0x79, 0x3b, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x3d, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x2e, 0x72, 0x65, 0x70, 0x6c, 0x61, 0x63, 0x65, 0x28, 0x2f, 0x79, 0x69, 0x65, 0x6c, 0x64, 0x5c, 0x28, 0x30, 0x2c, 0x2e, 0x2a, 0x3f, 0x5c, 0x2e, 0x67, 0x65, 0x74, 0x4c, 0x61, 0x74, 0x65, 0x73, 0x74, 0x55, 0x73, 0x65, 0x72, 0x44, 0x61, 0x74, 0x61, 0x5c, 0x29, 0x5c, 0x28, 0x5c, 0x29, 0x2f, 0x2c, 0x27, 0x7b, 0x22, 0x75, 0x73, 0x65, 0x72, 0x49, 0x64, 0x22, 0x3a, 0x22, 0x65, 0x6d, 0x61, 0x69, 0x6c, 0x7c, 0x30, 0x22, 0x2c, 0x22, 0x65, 0x6d, 0x61, 0x69, 0x6c, 0x22, 0x3a, 0x22, 0x70, 0x61, 0x74, 0x63, 0x68, 0x65, 0x64, 0x40, 0x68, 0x74, 0x74, 0x70, 0x74, 0x6f, 0x6f, 0x6c, 0x6b, 0x69, 0x74, 0x2e, 0x74, 0x65, 0x63, 0x68, 0x22, 0x2c, 0x22, 0x73, 0x75, 0x62, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x22, 0x3a, 0x7b, 0x22, 0x73, 0x74, 0x61, 0x74, 0x75, 0x73, 0x22, 0x3a, 0x22, 0x61, 0x63, 0x74, 0x69, 0x76, 0x65, 0x22, 0x2c, 0x22, 0x70, 0x6c, 0x61, 0x6e, 0x22, 0x3a, 0x22, 0x70, 0x72, 0x6f, 0x2d, 0x70, 0x65, 0x72, 0x70, 0x65, 0x74, 0x75, 0x61, 0x6c, 0x22, 0x2c, 0x22, 0x73, 0x6b, 0x75, 0x22, 0x3a, 0x22, 0x70, 0x72, 0x6f, 0x2d, 0x70, 0x65, 0x72, 0x70, 0x65, 0x74, 0x75, 0x61, 0x6c, 0x22, 0x2c, 0x22, 0x74, 0x69, 0x65, 0x72, 0x43, 0x6f, 0x64, 0x65, 0x22, 0x3a, 0x22, 0x70, 0x72, 0x6f, 0x22, 0x2c, 0x22, 0x69, 0x6e, 0x74, 0x65, 0x72, 0x76, 0x61, 0x6c, 0x22, 0x3a, 0x22, 0x70, 0x65, 0x72, 0x70, 0x65, 0x74, 0x75, 0x61, 0x6c, 0x22, 0x2c, 0x22, 0x71, 0x75, 0x61, 0x6e, 0x74, 0x69, 0x74, 0x79, 0x22, 0x3a, 0x31, 0x2c, 0x22, 0x65, 0x78, 0x70, 0x69, 0x72, 0x79, 0x22, 0x3a, 0x6e, 0x65, 0x77, 0x20, 0x44, 0x61, 0x74, 0x65, 0x28, 0x22, 0x39, 0x39, 0x39, 0x39, 0x2d, 0x30, 0x31, 0x2d, 0x30, 0x31, 0x54, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x3a, 0x30, 0x30, 0x2e, 0x30, 0x30, 0x30, 0x5a, 0x22, 0x29, 0x2c, 0x22, 0x75, 0x70, 0x64, 0x61, 0x74, 0x65, 0x42, 0x69, 0x6c, 0x6c, 0x69, 0x6e, 0x67, 0x44, 0x65, 0x74, 0x61, 0x69, 0x6c, 0x73, 0x55, 0x72, 0x6c, 0x22, 0x3a, 0x22, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x2f, 0x2f, 0x67, 0x69, 0x74, 0x68, 0x75, 0x62, 0x2e, 0x63, 0x6f, 0x6d, 0x2f, 0x37, 0x69, 0x37, 0x75, 0x35, 0x2f, 0x68, 0x74, 0x74, 0x70, 0x2d, 0x74, 0x6f, 0x6f, 0x6c, 0x6b, 0x69, 0x74, 0x2d, 0x70, 0x61, 0x74, 0x63, 0x68, 0x65, 0x72, 0x22, 0x2c, 0x22, 0x63, 0x61, 0x6e, 0x63, 0x65, 0x6c, 0x53, 0x75, 0x62, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x55, 0x72, 0x6c, 0x22, 0x3a, 0x22, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x2f, 0x2f, 0x67, 0x69, 0x74, 0x68, 0x75, 0x62, 0x2e, 0x63, 0x6f, 0x6d, 0x2f, 0x37, 0x69, 0x37, 0x75, 0x35, 0x2f, 0x68, 0x74, 0x74, 0x70, 0x2d, 0x74, 0x6f, 0x6f, 0x6c, 0x6b, 0x69, 0x74, 0x2d, 0x70, 0x61, 0x74, 0x63, 0x68, 0x65, 0x72, 0x22, 0x2c, 0x22, 0x6c, 0x61, 0x73, 0x74, 0x52, 0x65, 0x63, 0x65, 0x69, 0x70, 0x74, 0x55, 0x72, 0x6c, 0x22, 0x3a, 0x22, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x2f, 0x2f, 0x67, 0x69, 0x74, 0x68, 0x75, 0x62, 0x2e, 0x63, 0x6f, 0x6d, 0x2f, 0x37, 0x69, 0x37, 0x75, 0x35, 0x2f, 0x68, 0x74, 0x74, 0x70, 0x2d, 0x74, 0x6f, 0x6f, 0x6c, 0x6b, 0x69, 0x74, 0x2d, 0x70, 0x61, 0x74, 0x63, 0x68, 0x65, 0x72, 0x22, 0x2c, 0x22, 0x63, 0x61, 0x6e, 0x4d, 0x61, 0x6e, 0x61, 0x67, 0x65, 0x53, 0x75, 0x62, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x69, 0x6f, 0x6e, 0x22, 0x3a, 0x74, 0x72, 0x75, 0x65, 0x7d, 0x2c, 0x22, 0x66, 0x65, 0x61, 0x74, 0x75, 0x72, 0x65, 0x46, 0x6c, 0x61, 0x67, 0x73, 0x22, 0x3a, 0x5b, 0x5d, 0x2c, 0x22, 0x62, 0x61, 0x6e, 0x6e, 0x65, 0x64, 0x22, 0x3a, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x7d, 0x27, 0x29, 0x3b, 0x70, 0x61, 0x74, 0x63, 0x68, 0x5f, 0x61, 0x6c, 0x65, 0x72, 0x74, 0x28, 0x22, 0x50, 0x61, 0x74, 0x63, 0x68, 0x65, 0x64, 0x20, 0x6d, 0x61, 0x69, 0x6e, 0x2e, 0x6a, 0x73, 0x22, 0x29, 0x3b, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x20, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x73, 0x65, 0x6e, 0x64, 0x43, 0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x28, 0x22, 0x46, 0x65, 0x74, 0x63, 0x68, 0x2e, 0x66, 0x75, 0x6c, 0x66, 0x69, 0x6c, 0x6c, 0x52, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x22, 0x2c, 0x7b, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x3a, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x2c, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x65, 0x43, 0x6f, 0x64, 0x65, 0x3a, 0x70, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x2e, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x65, 0x53, 0x74, 0x61, 0x74, 0x75, 0x73, 0x43, 0x6f, 0x64, 0x65, 0x2c, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x65, 0x48, 0x65, 0x61, 0x64, 0x65, 0x72, 0x73, 0x3a, 0x70, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x2e, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x65, 0x48, 0x65, 0x61, 0x64, 0x65, 0x72, 0x73, 0x2c, 0x62, 0x6f, 0x64, 0x79, 0x3a, 0x42, 0x75, 0x66, 0x66, 0x65, 0x72, 0x2e, 0x66, 0x72, 0x6f, 0x6d, 0x28, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x29, 0x2e, 0x74, 0x6f, 0x53, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x28, 0x22, 0x62, 0x61, 0x73, 0x65, 0x36, 0x34, 0x22, 0x29, 0x7d, 0x29, 0x7d, 0x29, 0x29, 0x2e, 0x63, 0x61, 0x74, 0x63, 0x68, 0x28, 0x28, 0x65, 0x72, 0x72, 0x3d, 0x3e, 0x7b, 0x70, 0x61, 0x74, 0x63, 0x68, 0x5f, 0x61, 0x6c, 0x65, 0x72, 0x74, 0x28, 0x22, 0x46, 0x61, 0x69, 0x6c, 0x65, 0x64, 0x20, 0x74, 0x6f, 0x20, 0x70, 0x61, 0x74, 0x63, 0x68, 0x20, 0x6d, 0x61, 0x69, 0x6e, 0x2e, 0x6a, 0x73, 0x22, 0x29, 0x3b, 0x77, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x2e, 0x77, 0x65, 0x62, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x2e, 0x64, 0x65, 0x62, 0x75, 0x67, 0x67, 0x65, 0x72, 0x2e, 0x73, 0x65, 0x6e, 0x64, 0x43, 0x6f, 0x6d, 0x6d, 0x61, 0x6e, 0x64, 0x28, 0x22, 0x46, 0x65, 0x74, 0x63, 0x68, 0x2e, 0x63, 0x6f, 0x6e, 0x74, 0x69, 0x6e, 0x75, 0x65, 0x52, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x22, 0x2c, 0x7b, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x3a, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, 0x49, 0x64, 0x7d, 0x29, 0x7d, 0x29, 0x29, 0x7d, 0x29, 0x29, 0x3b, 0x0d, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x69, 0x66, 0x20, 0x28, 0x73, 0x68, 0x6f, 0x75, 0x6c, 0x64, 0x41, 0x75, 0x74, 0x6f, 0x48, 0x69, 0x64, 0x65, 0x4d, 0x65, 0x6e, 0x75, 0x28, 0x29, 0x29, 0x20, 0x7b
				]
			}
		]);

		return m;
	})
}

fn replace_bytes(data: &[u8], target: &[u8], replacement: &[u8]) -> Vec<u8> {
	let mut result = Vec::new();
	let mut i = 0;

	while i < data.len() {
		if i + target.len() <= data.len() && &data[i..i + target.len()] == target {
			result.extend_from_slice(replacement);
			i += target.len();
		} else {
			result.push(data[i]);
			i += 1;
		}
	}
	result
}

fn clear_log(ui_weak: &slint::Weak<AppWindow>) {
	let handle_weak = ui_weak.clone();

	slint::invoke_from_event_loop(move || {
		if let Some(ui) = handle_weak.upgrade() {
			ui.set_log("".into());
		}
	}).unwrap();
}

fn append_log(ui_weak: &slint::Weak<AppWindow>, text: &str) {
	let text = text.to_string();
	let handle_weak = ui_weak.clone();

	slint::invoke_from_event_loop(move || {
		if let Some(ui) = handle_weak.upgrade() {
			let log = ui.get_log();
			let updated = format!("{}\n{}", log, text);
			ui.set_log(updated.into());
		}
	}).unwrap();
}

fn kill_httptoolkit() {
	if cfg!(windows) {
		let _ = Command::new("powershell")
			.args([
				"-Command",
				"Start-Process taskkill -ArgumentList '/F /IM \"http toolkit.exe\"' -Verb RunAs"
			])
			.status();
	} else if cfg!(target_os = "macos") || cfg!(unix) {
		let _ = Command::new("sudo")
			.arg("pkill")
			.arg("httptoolkit")
			.status();
	}
}

fn patch_asar_file<P: AsRef<Path>>(asar_path: P, ui: &slint::Weak<AppWindow>) -> Result<(), String> {
	clear_log(ui);
	append_log(ui, "Starting patch!");
	append_log(ui, "Killing HTTP Toolkit process.");
	kill_httptoolkit();
	append_log(ui, "Reading asar file.");

	let asar_file = fs::read(asar_path.as_ref()).map_err(|_| "Failed to read ASAR file")?;
	let asar = AsarReader::new(&asar_file, None).map_err(|_| "Failed to parse ASAR file")?;

	let mut patched_asar = AsarWriter::new();
	append_log(ui, "Recreating files. Please wait...");

	let patches = init_patches();
	for (path, file) in asar.files() {
		let path_string = path.to_string_lossy();
		if !patches.contains_key(path_string.as_ref()) {
			patched_asar.write_file(path, file.data(), false).map_err(|_| format!("Failed to recreate file: {}", path_string.as_ref()))?;
		}
	}
	append_log(ui, "Files recreated!");

	for (path_string, patch_list) in patches.iter() {
		let path = Path::new(path_string);
		if let Some(file) = asar.files().get(path) {
			let mut bytes = file.data().to_vec();
			for patch in patch_list {
				let patched_bytes = replace_bytes(&bytes, &patch.original, &patch.replacement);
				if patched_bytes != bytes {
					bytes = patched_bytes;
					append_log(ui, &format!("Applying patch for: {}", path_string));
				} else {
					append_log(ui, &format!("Could not apply patch for: {}", path_string));
					return Err("Failed to apply patches (This may mean it has already been patched)".into());
				}
			};
			patched_asar.write_file(path, bytes, false).map_err(|_| format!("Failed to write the patched file: {}", path_string))?;
		}
	}


	let mut backup_path = asar_path.as_ref().to_path_buf();
	backup_path.set_file_name("app.asar.backup");
	fs::rename(&asar_path, &backup_path).map_err(|_| "Failed to backup app.asar")?;
	append_log(ui, "Writing patched ASAR");

	let patched_writer = fs::File::create(&asar_path).map_err(|_| "Failed to create patched ASAR file")?;
	patched_asar.finalize(patched_writer).map_err(|_| "Failed to finalize patched ASAR")?;

	Ok(())
}


fn get_os_name() -> &'static str {
	if cfg!(windows) {
		"windows"
	} else if cfg!(target_os = "macos") {
		"macos"
	} else if cfg!(unix) {
		"unix"
	} else {
		"unknown"
	}
}

fn detect_asar_path() -> Option<String> {
	let map = init_asar_paths();
	let paths = map.get(get_os_name())?;
	for path in paths {
		if Path::new(path).exists() {
			return Some(path.to_string());
		}
	}
	return None;
}

fn alert(message: &str, title: &str) {
	let _ = DialogBuilder::message()
		.set_level(MessageLevel::Error)
		.set_title(title)
		.set_text(message)
		.alert()
		.show();
}

fn main() -> Result<(), Box<dyn Error>> {
	let ui = AppWindow::new()?;
	let ui_weak = ui.as_weak();
	let path = detect_asar_path();
	if let Some(value) = path {
		ui.set_asar_path(value.into());
	}
	ui.set_patcher_version(PATCHER_VERSION.into());

	let ui_weak_select = ui_weak.clone();
	ui.on_select_asar_path(move || {
		let Some(ui) = ui_weak_select.upgrade() else {
			return;
		};

		let file = rfd::FileDialog::new()
			.add_filter("Asar Files", &["asar"])
			.set_directory("/")
			.pick_file();

		if let Some(path) = file {
			ui.set_asar_path(path.to_string_lossy().to_string().into());
			ui.set_can_patch(true);
		}
	});

	let ui_weak_patch = ui_weak.clone();
	ui.on_patch_asar_file(move || {
		let Some(ui) = ui_weak_patch.upgrade() else {
			return;
		};
		ui.set_can_patch(false);
		let path = detect_asar_path().unwrap_or(ui.get_asar_path().into());
		if path == "Could not detect Asar file" {
			alert("No asar file is set!", "Failed to patch");
			return;
		}

		let ui_weak_patch_thread = ui_weak_patch.clone();
		std::thread::spawn({
			let ui_weak = ui_weak_patch_thread.clone();
			let path = path.clone();
			move || {
				let update_ui = |message: String| {
					let ui_weak = ui_weak.clone();
					let message_copy = message.clone();
					slint::invoke_from_event_loop(move || {
						if let Some(ui) = ui_weak.upgrade() {
							ui.set_can_patch(true);
							append_log(&ui_weak, &message_copy);
						}
					}).unwrap();
				};

				match patch_asar_file(&path, &ui_weak) {
					Ok(_) => update_ui("SUCCESS: PATCH COMPLETED!".to_string()),
					Err(err) => update_ui(format!("FAILURE: UNABLE TO PATCH! {}", err)),
				}
			}
		});

	});

	ui.run()?;
	Ok(())
}
